TASK OBJECTIVES
1. Security Improvements
âœ… Enforce MIME type validation server-side (PDF, JPEG, PNG only).

âœ… Add MAX_CONTENT_LENGTH = 16 * 1024 * 1024 (16MB) in Flask config to block large file uploads.

âœ… Use @app.errorhandler(413) to handle oversized file responses gracefully.

âœ… Ensure secure_filename() is used wherever filenames are saved or logged.

âœ… Validate/sanitize all user-provided data and invoice fields before DB insert.

2. Workflow and Parser Resilience
âœ… In utils.py, improve parse_invoice() to robustly fall back to Eyelevel.ai on any exception or failure from LlamaCloud.

âœ… Make sure raw OCR data from either parser is saved under clear keys (raw_extraction_data or raw_xray).

âœ… Add a parser_used field to each invoice entry (optional) or infer from available raw keys.

âœ… Implement a job queue or background task stub (e.g., Celery task or threading.Thread) to optionally offload invoice parsing.

3. Frontend UX Enhancements
âœ… On file upload (main.js):

Show progress states visually (step-processing, step-complete, step-error).

Use a 60s client-side timeout. Inform the user if timeout is hit and advise checking history.

âœ… Ensure the parser used (LlamaCloud or Eyelevel) is clearly labeled in UI badges (Primary vs Fallback).

âœ… Show raw JSON data toggle by parser type (e.g., collapsible "Show Raw Data (LlamaCloud)" section).

4. Error Logging and Monitoring
âœ… Improve logging:

Log OCR failures (including filename and exception)

Log parser fallback events (primary â†’ fallback)

âœ… For unexpected server errors (500s), return { success: false, error: <msg> } in JSON format.

âœ… Wrap all parsing steps in try/except blocks and ensure fallback paths work even on raised exceptions.

ğŸ› ï¸ FILES AFFECTED
routes.py â€“ Flask app routing and upload logic

utils.py â€“ Parsing orchestration, transformation, normalization

static/js/main.js â€“ Frontend interactivity and UI status handling

app.py or Flask config â€“ Add file size limit

(Optional) tasks.py â€“ Future background processing

ğŸ” REMEMBER
Use meaningful log messages (logger.debug, logger.error, etc.).

Do not use placeholder code. Implement full working logic.

Test upload, parsing, fallback, and UI feedback end-to-end.